<?xml version="1.0" encoding="UTF-8"?>
<project name="Kaltura Java Client Library" default="compile" basedir=".">
	<property file="build.properties" />

	<property name="project.dir" value="." />
	<property name="label" value="3.2" />
	<property name="build.dir" value="${project.dir}/build" />
	<property name="bin.dir" value="${project.dir}/bin" />
	<property name="lib.dir" value="${project.dir}/lib" />
	<property name="project.name" value="kaltura-java-client-${label}" />
	<property name="package.file.zip" value="${build.dir}/${project.name}.zip" />
	<property name="package.file.jar" value="${build.dir}/${project.name}.jar" />
	<property name="project.file.zip" value="${build.dir}/${project.name}-project.zip" />    
	<property name="source.dir" value="${project.dir}/src" />
	<property name="source.java.dir" value="${source.dir}/java" />
	<property name="source.php.dir" value="${source.dir}/php" />
	<property name="output.dir" value="${source.php.dir}/output" />
	<property name="output.java.dir" value="${output.dir}/java" />

	<path id="classpath.local">
		<fileset dir="${project.dir}/lib" includes="**/*.jar" />
	</path>

	<path id="classpath.build">
	    <fileset dir="${build.dir}" includes="**/*.jar" />
    </path>
    
	<target name="clean" description="Removes all generated files">
		<delete dir="${build.dir}" />
		<delete dir="${bin.dir}" />		
	</target>

	<target name="clean-generated-client" description="Removes classes generated by client generator">
		<delete dir="${output.dir}" />
	</target>
	
	<target name="setup" description="Creates the ${build.dir}, ${bin.dir}, ${output.dir} directories">
		<mkdir dir="${build.dir}" />
		<mkdir dir="${bin.dir}" />
		<mkdir dir="${output.dir}" />
	</target>

	<target name="compile" description="Compiles src to ${bin.dir}">
		<mkdir dir="${bin.dir}" />
		<javac srcdir="${source.java.dir}" destdir="${bin.dir}" source="1.5" target="1.5" debug="on" fork="yes" deprecation="on">
			<classpath refid="classpath.local"/>			
		</javac>
		<!-- copy in non-compiled files like props if needed -->
		<copy todir="${bin.dir}">
			<fileset dir="${source.java.dir}" excludes="**/*.java"/>
		</copy>
	</target>
	
	<target name="jar" depends="setup, compile"
		description="Jars up the compiled classes">
			<delete file="${package.file.jar}" />
			<jar destfile="${package.file.jar}">
				<fileset dir="${bin.dir}" includes="**" />								
			</jar>
	</target>
		
	<target name="test" depends="jar">
		<junit fork="yes" haltonfailure="yes">
			<test name="com.kaltura.client.tests.KalturaTestSuite" />
			<formatter type="plain" usefile="false" />
			<classpath refid="classpath.local" />
			<classpath refid="classpath.build" />
		</junit>
	</target>
	
	<target name="setup-php-deps">
		<!-- The Java generator doesn't use these but the Kaltura PHP code will fail as written if not present -->
		<mkdir dir="${source.php.dir}/sources" />
		<mkdir dir="${source.php.dir}/sources/java" />
	</target>
	
	<target name="generate-client" depends="generate-client-classes, copy-to-java-src" />
	
	<target name="generate-client-classes" depends="setup-php-deps">
        <exec executable="php" dir="${source.php.dir}">
            <arg value="-f"/>
            <arg value="generate_client.php"/>
        </exec>
    </target>
	
	<target name="copy-to-java-src">
		<copy todir="${source.java.dir}">
			<fileset dir="${source.php.dir}/output/java" />
		</copy>
	</target>
		
</project>
